# 功能列表
- 账号
    - 注册：创建账号
    - 注销：注销账号
- 关系
    - 添加好友
    - 删除好友
    - 成为好友
- 联系人
    - 通讯录
    - 最近联系人
- 消息
    - 文字聊天
    - 语音聊天
    - 视频聊天  
- 会话
    - 点对点单聊
    - 多对多群里

# 表设计
- 用户表
<table>
    <tr>
        <td>用户ID</td>
        <td>用户名</td>
        <td>头像</td>
        <td>手机号</td>
        <td>性别</td>
        <td>年龄</td>
        <td>用户状态</td>
        <td>注册时间</td>
    </tr>
    <tr>
        <td>wxid_itkmlvme1c0321</td>
        <td>Lucky12</td>
        <td>url</td>
        <td>13121295801</td>
        <td>男</td>
        <td>30</td>
        <td>被封禁/已注销</td>
        <td>2020-04-21 12:03:04</td>
    </tr>    
</table>

- 群组表
    - 根据用户在群中的已读最新消息游标，可以控制新入群的看不到之前的消息
<table>
    <tr>
        <td>群组ID</td>
        <td>用户UID</td>
        <td>用户在群中的已读最新消息游标</td>
        <td>创建时间</td>
    </tr>
    <tr>
        <td>12345</td>
        <td>87654321(李四的UID)</td>
        <td>123459</td>
        <td>创建时间</td>
    </tr>
</table>

- 通讯录表
    - 用户双方的关系是成对的(好友/解除好友/拉黑/被拉黑/关注/粉丝..)
    - 好友：张三和李四是好友，张三和李四、李四和张三的关系都标记为好友
    - 解除好友：张三解除和李四的关系，张三对李四标记为非好友，李四对张三可以是非好友也可以是好友(聊天时才发现张三解除了关系)
    - 拉黑：张三拉黑李四，张三对李四标记为黑名单，李四对张三标记为被拉黑
    - 关注：张三关注李四，张三对李四标记为关注，李四对张三标记为粉丝
<table>
    <tr>
        <td>索引的用户UID</td>
        <td>索引的另一方用户UID</td>
        <td>关系</td>
        <td>创建时间</td>
    </tr>
    <tr>
        <td>87654321(李四的UID)</td>
        <td>12345678(张三的UID)</td>
        <td>关注</td>
        <td>创建时间</td>
    </tr>
    <tr>
        <td>12345678(张三的UID)</td>
        <td>87654321(李四的UID)</td>
        <td>粉丝</td>
        <td>创建时间</td>
    </tr>
</table>

- 最近联系人表
<table>
    <tr>
        <td>索引的用户UID</td>
        <td>索引的另一方用户UID</td>
        <td>消息ID</td>
    </tr>
    <tr>
        <td>87654321(李四的UID)</td>
        <td>12345678(张三的UID)</td>
        <td>1001</td>
    </tr>
    <tr>
        <td>12345678(张三的UID)</td>
        <td>87654321(李四的UID)</td>
        <td>1001</td>
    </tr>
</table>

- 单聊消息表
<table>
    <tr>
        <td>消息ID</td>
        <td>消息内容</td>
        <td>消息类型</td>
        <td>消息产生时间</td>
    </tr>
    <tr>
        <td>1001</td>
        <td>你好</td>
        <td>文本消息</td>
        <td>2019-07-15 12:00:00</td>
    </tr>
</table>

- 单聊会话表
    - 这个是写扩散，1条消息会写收发双方
<table>
    <tr>
        <td>索引的用户UID</td>
        <td>索引的另一方用户UID</td>
        <td>是发件箱还是收件箱</td>
        <td>消息ID</td>
    </tr>
    <tr>
        <td>87654321(李四的UID)</td>
        <td>12345678(张三的UID)</td>
        <td>0</td>
        <td>1001</td>
    </tr>
    <tr>
        <td>12345678(张三的UID)</td>
        <td>87654321(李四的UID)</td>
        <td>1</td>
        <td>1001</td>
    </tr>
</table>

- 群聊会话表
    - 这个是读扩展，1条消息就是一条消息
    - 相比单聊，这个的接收对象变成了群
<table>
    <tr>
        <td>发送者ID</td>
        <td>群ID</td>
        <td>消息ID</td>
        <td>消息内容</td>
        <td>消息类型</td>
        <td>消息产生时间</td>
    </tr>
    <tr>
        <td>87654321(李四的UID)</td>
        <td>1234</td>
        <td>123</td>
        <td>一段语音</td>
        <td>语音</td>
        <td>2019-07-15 12:00:00</td>
    </tr>
</table>

# IM系统的特性
```
1、实时性：如果互动不能实时就不是合格的IM
2、可靠性
    不丢消息：一方以为消息送达了，但是另一放一直没有收到
    消息不重复：比如直播间的送礼信息重复发送了，处理不妥当会导致用户损失
3、一致性：假如不一致即是乱序，会出现很多误会、惨案
    同一条消息在多人、多终端要保证展示的顺序一致性
    单聊中，发送方的发送顺序和接收方的接收顺序一致
    群聊中，群里的人在群里接收到的消息顺序是一致的
4、安全性
    数据传输安全
    数据存储安全(消息内容安全)
5、节能省电、省流量    
```
