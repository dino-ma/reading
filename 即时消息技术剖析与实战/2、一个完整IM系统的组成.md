# App聊天系统为例
## 使用者视角
```
用户账号：给用户唯一标识(还有头像、昵称...)
关系链：账号和账号之间通过某些方式(加好友、关注、取消关注、拉黑...)
联系人：好友列表、最近联系人列表、关注列表、粉丝列表、黑名单列表...
消息：用户和用户之间互动产生消息
会话：用户和用户之间的所有互动消息
```

## 开发者视角
```
客户端：用户用来收发消息的终端设备(手机、平板、电脑...)，承载用户的互动请求和消息的收发
接入服务：连接保持(维持心跳信息)、协议解析(让业务处理时不需要关心业务无关的编码工作)、session维护(用户的设备在哪个TCP连接)、消息推送
业务处理： 消息业务逻辑处理(消息存储、未读数变更、更新最近联系人..)
存储服务：账号信息、关系链、消息本身都要进行持久化存储
外部接口服务：App未打开或因后台运行导致和IM服务端断开时，也能收到消息
            使用第三方外部接口服务，通过手机操作系统自身的公共连接服务进行操作系统级的消息推送，
            这种方式下发的消息一般在手机的会以"通知栏"对用户进行提醒和展示
```

### 第三方系统推送服务
```
提升“自建的长连接不可用“时，实时触达的能力
APNS：Apple Push Notification服务
GCM：Google Cloud Messaging服务，但是在国内无法使用
小米、华为、OPPO、vivo等手机厂商都有相应的SDK支持
```

### 为什么接入服务和业务处理服务独立拆分
```
1、接入服务确保高可用：消息的收发入口，必须是高可用的，保持足够的稳定性。把不需要频繁变更的接入层抽离出来独立
        假设和业务处理放在一起，随着产品需求的迭代，业务处理的变更频繁。会让接入模块随着业务逻辑变更上线而频繁起停
        导致已经通过网络接入的客户端连接经常性的断连、重置、重连
2、提升业务开发效率，降低业务开发门槛：接入服务负责一切网络通信相关的部分，业务处理更加专注于业务逻辑的处理
```

# IM系统的特性
```
1、实时性：如果互动不能实时就不是合格的IM
2、可靠性
    不丢消息：一方以为消息送达了，但是另一放一直没有收到
    消息不重复：比如直播间的送礼信息重复发送了，处理不妥当会导致用户损失
3、一致性：假如不一致即是乱序，会出现很多误会、惨案
    同一条消息在多人、多终端要保证展示的顺序一致性
    单聊中，发送方的发送顺序和接收方的接收顺序一致
    群聊中，群里的人在群里接收到的消息顺序是一致的
4、安全性
    数据传输安全
    数据存储安全(消息内容安全)
5、节能省电、省流量    
```

# 问题和解决方案
```
1、消息一定需要在服务端的存储服务里进行存储？
需要存储的情况
    功能上要支持多端消息记录同步
    暂存离线消息
    历史消息的搜索
    相关监管部门的要求
```