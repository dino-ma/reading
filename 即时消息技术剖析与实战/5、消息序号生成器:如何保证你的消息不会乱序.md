# 消息的一致性
```
消息的时序代表的是发送方的意见表述、接收方的语义逻辑理解。
如果时序不一致性，就会造成聊天语义不连贯、出现曲解和误会
时序不一致就像是一个人说话颠三倒四，前言不搭后语的样子
```

## 保证消息的时序一致性很难
```
理想：收发双方都是单线程操作，且和IM服务端都只有唯一的一个TCP连接进行通信，IM服务端也只有一个线程处理消息的收发
现实：收发双方单处理线程吞吐量和效率都太低，不太可能存在理想的情况。
消息的时序一致性是要求我们的消息具备”时序可比较性“，我们需要找到一个时序基准让消息具备"时序可比较性"
```

## 解决消息时序一致性的方案
- 如何找到时序基准
- 时序基准的可用性是不是可以
- 有了时序基准，还有其它的误差吗，有什么办法可以减少误差

### 时序基准(作标识)
- 解决每条消息没有标”生产日期的问题“
- 在高并发场景下需要确保"全局序号生成器"的可用性
<table>
    <tr>
        <td>方案</td>
        <td>可靠性</td>
        <td>优缺点</td>
    </tr>
    <tr>
        <td>IM服务器的本地化时钟</td>
        <td>低</td>
        <td>虽然多台服务器通过NTP时间同步,但是也存在时钟的差异</td>
    </tr>
    <tr>
        <td>全局递增序号-Redis的incr、DB自增ID</td>
        <td>高</td>
        <td>原子自增和DB的自增ID都要求在主库上来执行取号操作，主库单点部署容易出现瓶颈</td>
    </tr>
    <tr>
        <td>类似snowflake算法的全局序号生成器</td>
        <td>高(秒级别时间内有序)</td>
        <td>可以按照每个群独立一个ID生成器,通过哈希规则把压力分散到多个主库实例上</td>
    </tr>    
</table>

### 时序基准之外的误差
- 时序基准是用来进行排序的,它不能表示就一定按照"既定顺序"到达接收方
- 端上需要能对消息进行”本地整流“即合并
    - 消息服务端包内整流,在每个消息包内对一定时间内的消息做一个整流和排序，然后下发
    - 消息接收端本地整流，根据消息序号进行排序
- 保证了接收方的最终一致性

# 问题和解决方案
```
1、在即时消息收发场景中，用于保证消息接收时序的序号生成器为什么可以不是全局递增的？
比如按照业务划分，在该业务内是全局递增的即可。不需要所有的业务中都是全局递增的
单聊提供一个派号器、群聊提供一个派号器。相比较群聊单聊使用一个派号器要好，最近联系人可能还需要使用其他属性进行全局排序(比如消息产生的时间戳)
由业务场景决定的，这个群的消息和另一个群的消息在逻辑上是完全隔离的，只要保证消息的序号在群这样的一个局部范围内是递增的即可； 
当然如果可以做到全局递增最好，但是会浪费很多的资源，却没有带来更多的收益。
```