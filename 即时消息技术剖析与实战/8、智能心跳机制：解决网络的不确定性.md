# 回顾
```
前面提到IM中两个重要的特性：“可靠投递”、“实时性”，我们会采样长连接的方式建立收发双方的通道。
当用户上线连接时，会在服务端维护好连接到服务器的用户设备和TCP连接的映射关系，当网络中断时这个映射关系会被清除。
```

# 为什么需要心跳机制
```
"长连接"底层使用的TCP连接并不是一个真正存在的物理连接，只是一个无感知的虚拟连接。
中间链路的断开两端都不会感知到，为了解决两端感知的问题需要引入“心跳机制”。
通过持续的往连接上发送“心跳数据”来试探连接的可用性，其实就是一问一答的方式。
```

## 降低服务端连接维护的开销
- 心跳机制可以让IM服务端感知到连接的变化，尽早清理已经断开的连接
- 假如IM服务端感知不到这些连接的异常，会导致可能维护了大量的无效连接、往无效的连接推/重试消息会降低服务的整体性能

## 支持客户端断线重连
```
通过心跳支撑客户端的断开重连机制，对客户端发出的心跳包(考虑网络传输的耗时,这个超时要大于一个心跳的间隔)
客户端连续2次发送心跳包，都没有收发IM服务端的响应，那客户端认为和服务端的长连接不可用，客户端断开重连
```

## 连接保活
```
心跳可以让客户端和IM服务端建立起来的连接存活更长一些
因为在用户网络和中间网络都正常的情况下，长连接也可能会被杀死
运营商为了节省资源和降低自身网关的压力，对于一段时间没有数据收发的连接，运营商会从NAT映射表中清除(心跳机制就可以避免这种情况)
```

# 心跳的几种实现方式
## TCP Keepalive
```
TCP的Keepalive是操作系统TCP/IP协议实现的一部分,操作系统默认是关闭的,需要应用层开启
会发送不携带数据的探测报文，探测对方是否存活
优点：易用性好、网络消耗小
缺点：心跳间隔灵活性查(只能固定)、它是连接层的探测(不代表应用层的状态)
```

## 应用层心跳
```
为了解决连接层心跳存在的不足，很多时候IM服务使用应用层心跳来提升探测的灵活性和准确性
应用层心跳就是客户端每隔一定时间间隔向IM服务端发送一个业务层的数据包告知自身存活
如果IM服务端在一定时间没有收到心跳包，就认为客户端由于某种原因连接不可达，断开连接同时清除相应分配的资源
优点：灵活控制心跳间隔
缺点：需要一定的网络消耗
```

## 智能心跳
```
各个地方的运营商在不同网络类型下NAT超时的时间差异性很大
将心跳间隔设置为小于所有网络环境下NAT超时的最短时间虽然可以
但是对于设备CPU、电量、网络流量的资源无法做到最大程度的节约
为了解决这个问题采用“智能心跳”的方案，进行平衡"NAT超时"和"设备资源节约"
随着移动设备的条件越来越好，智能心跳对设备节约的效果有限，智能心跳需要不断尝试。根据自身业务需求衡量必要性
```

# 问题和解决方案
```
1、心跳机制中可以结合 TCP 的 keepalive 和应用层心跳来一起使用吗？
心跳主要解决就是机器断电、网线拔出、防火墙导致断线的情况
传输层的心跳和应用层的心跳机制没有结合的必要，传输层心跳是探测连接的可用性，应用层的探测无法确定是系统层还是网络层。需要TCP心跳包的辅助
```