# 实时互动能力
```
现有业务的情况下想要增加一个互动模块
支持用户点对点实时聊天、让视频支持弹幕...
```
![markdown](https://github.com/youngperson/reading/blob/master/%E5%8D%B3%E6%97%B6%E6%B6%88%E6%81%AF%E6%8A%80%E6%9C%AF%E5%89%96%E6%9E%90%E4%B8%8E%E5%AE%9E%E6%88%98/images/ImFunc.png)


# 增加即时消息功能
## 消息维度
- 消息存储(内容表)：收发双方看到的消息内容都是一致的
<table>
    <tr>
        <td>消息ID</td>
        <td>消息内容</td>
        <td>消息类型</td>
        <td>消息产生时间</td>
    </tr>    
    <tr>
        <td>1001</td>
        <td>你好</td>
        <td>文本消息</td>
        <td>2020-05-02 7:29:11</td>
    </tr>
</table>

- 消息收发通道(从客户端角度)
    - 消息的发送通道
        - IM服务端提供给客户端HTTP协议的API接口
        - 客户端和IM服务端维护一个TCP长连接
    - 消息的接收通道
        - 通过TCP长连接
        - 使用第三方辅助通道进行系统通知栏推送


## 聊天会话维度
- 消息索引表(查询双方的历史聊天记录)
<table>
    <tr>
        <td>索引的用户UID</td>
        <td>索引的另一方参与用户UID</td>
        <td>是发件还是收件</td>
        <td>消息ID</td>
    </tr>
    <tr>
        <td>12345678(张三的UID)</td>
        <td>87654321(李四的UID)</td>
        <td>0</td>
        <td>1001</td>
    </tr>
    <tr>
        <td>87654321(李四的UID)</td>
        <td>12345678(张三的UID)</td>
        <td>1</td>
        <td>1001</td>
    </tr>
</table>

- 会话未读计数(我和某个人有多少人未读消息)

## 用户全局维度
- 最近联系人列表(只更新存储收发双方的最新一条消息,用于查询某个人最近的所有联系人)
<table>
    <tr>
        <td>索引的用户UID</td>
        <td>索引的另一方参与用户UID</td>
        <td>消息ID</td>
    </tr>
    <tr>
        <td>12345678(张三的UID)</td>
        <td>87654321(李四的UID)</td>
        <td>1001</td>
    </tr>
    <tr>
        <td>87654321(李四的UID)</td>
        <td>12345678(张三的UID)</td>
        <td>1001</td>
    </tr>
</table>

- 总未读计数

# 问题和解决方案 
```
1、消息存储中，内容表和索引表要分库分表，用什么字段来哈希？索引表可以和内容表合并成一个表？
内容表使用主键消息ID进行哈希去分库分表
索引表使用UID进行哈希去分库分表：这样查某个用户的所有消息都是落在一张表
合并后消息内容那些数据都会冗余

2、能从索引表里面获取到最近联系人所需要的信息，为什么还需要单独的联系人表？
索引表是会话维度，单独的联系人表是用户全局的维度(避免查内容表用户所有记录然后分组排序)
```